name: Deploy Config Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'corretto'

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ${{ secrets.EC2_USER }}
        SOURCE: "target/*.jar"
        TARGET: "/home/${{ secrets.EC2_USER }}/config-server"
        SCRIPT_AFTER: |
          SERVICE_NAME="config-server"
          PORT=8888
          DIR="/home/${{ secrets.EC2_USER }}/$SERVICE_NAME"
          
          echo "--- Desplegando $SERVICE_NAME ---"
          
          # 1. Asegurar que el directorio existe
          mkdir -p $DIR
          
          # 2. Detener proceso en el puerto
          fuser -k $PORT/tcp || true
          
          # 3. Moverse al directorio y limpiar
          cd $DIR
          # Mover el jar subido (que cae en target/) a la raÃ­z del servicio
          mv target/*.jar . 2>/dev/null || true
          rm -rf target
          
          NEW_JAR=$(ls -t *.jar | head -n 1)
          echo "Ejecutando: $NEW_JAR"
          
          # 4. Iniciar con memoria baja (192MB)
          nohup java -Xms192m -Xmx192m -jar "$NEW_JAR" > $SERVICE_NAME.log 2>&1 &
